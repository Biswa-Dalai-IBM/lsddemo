<?xml version="1.0" encoding="UTF-8"?>

<FLOW VERSION="3.2" CLEANUP="true">

  <!-- nodes -->

<SEQUENCE EXIT-ON="FAILURE" FORM="TRY">

  <!-- nodes -->

<SEQUENCE EXIT-ON="FAILURE">

  <!-- nodes -->

<INVOKE SERVICE="com.example.customer:validateCustomer">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/customer;2;0/customerId;1;0" TO="/custId;1;0">
</MAPCOPY>

<MAPCOPY FROM="/customer;2;0/email;1;0" TO="/emailAddress;1;0">
</MAPCOPY>
</MAP>

<MAP MODE="OUTPUT">

  <!-- nodes -->

<MAPCOPY FROM="/isValid;1;0" TO="/customerValid;1;0">
</MAPCOPY>

<MAPCOPY FROM="/validationError;1;0" TO="/custValidationError;1;0">
</MAPCOPY>
</MAP>
</INVOKE>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/validationFailed;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">!customerValid</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">validationFailed</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>
</SEQUENCE>

<LOOP IN-ARRAY="/items" OUT-ARRAY="/processedItems">

  <!-- nodes -->

<BRANCH SWITCH="/items/productType">

  <!-- nodes -->

<SEQUENCE EXIT-ON="FAILURE">

  <!-- nodes -->

<INVOKE SERVICE="com.example.inventory:checkStock">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/items;2;1/itemId;1;0" TO="/productId;1;0">
</MAPCOPY>

<MAPCOPY FROM="/items;2;1/quantity;3;0" TO="/requestedQty;1;0">
</MAPCOPY>
</MAP>

<MAP MODE="OUTPUT">

  <!-- nodes -->

<MAPCOPY FROM="/available;1;0" TO="/stockAvailable;1;0">
</MAPCOPY>

<MAPCOPY FROM="/reservationId;1;0" TO="/stockReservation;1;0">
</MAPCOPY>
</MAP>
</INVOKE>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/items;2;1/status;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">"RESERVED"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">status</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPCOPY FROM="/stockReservation;1;0" TO="/items;2;1/reservationId;1;0">
</MAPCOPY>
</MAP>
</SEQUENCE>

<SEQUENCE EXIT-ON="FAILURE">

  <!-- nodes -->

<INVOKE SERVICE="com.example.digital:generateLicense">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/items;2;1/itemId;1;0" TO="/productId;1;0">
</MAPCOPY>

<MAPCOPY FROM="/customer;2;0/customerId;1;0" TO="/customerId;1;0">
</MAPCOPY>
</MAP>

<MAP MODE="OUTPUT">

  <!-- nodes -->

<MAPCOPY FROM="/licenseKey;1;0" TO="/items;2;1/licenseKey;1;0">
</MAPCOPY>
</MAP>
</INVOKE>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/items;2;1/status;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">"LICENSED"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">status</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>
</SEQUENCE>
</BRANCH>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/items;2;1/basePrice;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">items/quantity*items/unitPrice</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">basePrice</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPINVOKE SERVICE="com.example.pricing:applyDiscount" INVOKE-ORDER="0">

  <!-- nodes -->

<MAP MODE="INVOKEINPUT">

  <!-- nodes -->

<MAPCOPY FROM="/items;2;1/basePrice;1;0" TO="/amount;1;0">
</MAPCOPY>

<MAPCOPY FROM="/customer;2;0/loyaltyPoints;3;0" TO="/points;1;0">
</MAPCOPY>

<MAPCOPY FROM="/applyDiscount;3;0" TO="/shouldApplyDiscount;1;0">
</MAPCOPY>
</MAP>

<MAP MODE="INVOKEOUTPUT">

  <!-- nodes -->

<MAPCOPY FROM="/discountedPrice;1;0" TO="/items;2;1/finalPrice;1;0">
</MAPCOPY>

<MAPCOPY FROM="/discountApplied;1;0" TO="/items;2;1/discountAmount;1;0">
</MAPCOPY>
</MAP>
</MAPINVOKE>
</MAP>
</LOOP>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/totalAmount;3;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">0</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">totalAmount</value>
    <value name="field_type">object</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>

<INVOKE SERVICE="com.example.calculation:sumItemPrices">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/items;2;1" TO="/processedItems;2;1">
</MAPCOPY>
</MAP>

<MAP MODE="OUTPUT">

  <!-- nodes -->

<MAPCOPY FROM="/total;1;0" TO="/totalAmount;3;0">
</MAPCOPY>
</MAP>
</INVOKE>

<RETRY LOOP-ON="FAILURE">

  <!-- nodes -->

<INVOKE SERVICE="com.example.payment:processPayment">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/orderId;1;0" TO="/orderReference;1;0">
</MAPCOPY>

<MAPCOPY FROM="/customer;2;0/customerId;1;0" TO="/customerId;1;0">
</MAPCOPY>

<MAPCOPY FROM="/totalAmount;3;0" TO="/amount;1;0">
</MAPCOPY>
</MAP>

<MAP MODE="OUTPUT">

  <!-- nodes -->

<MAPCOPY FROM="/status;1;0" TO="/paymentStatus;1;0">
</MAPCOPY>

<MAPCOPY FROM="/transactionId;1;0" TO="/paymentTransactionId;1;0">
</MAPCOPY>
</MAP>
</INVOKE>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/retryCount;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">retryCount+1</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">retryCount</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>
</RETRY>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/success;3;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">true</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">success</value>
    <value name="field_type">object</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/status;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">"COMPLETED"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">status</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPCOPY FROM="/paymentTransactionId;1;0" TO="/transactionId;1;0">
</MAPCOPY>
</MAP>
</SEQUENCE>

<SEQUENCE EXIT-ON="FAILURE" FORM="CATCH">

  <!-- nodes -->

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/success;3;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">false</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">success</value>
    <value name="field_type">object</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/status;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">"FAILED"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">status</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPCOPY FROM="/$error;2;0/message;1;0" TO="/errorMessage;1;0">
</MAPCOPY>

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/isFatalError;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">errorMessage=="FATAL"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">isFatalError</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>

<INVOKE SERVICE="com.example.logging:logError">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/orderId;1;0" TO="/orderRef;1;0">
</MAPCOPY>

<MAPCOPY FROM="/errorMessage;1;0" TO="/error;1;0">
</MAPCOPY>

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/severity;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">"ERROR"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">severity</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>
</INVOKE>
</SEQUENCE>

<SEQUENCE EXIT-ON="FAILURE" FORM="CATCH">

  <!-- nodes -->

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/success;3;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">false</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">success</value>
    <value name="field_type">object</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/status;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">"SYSTEM_ERROR"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">status</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>

<MAPCOPY FROM="/$error;2;0/message;1;0" TO="/errorMessage;1;0">
</MAPCOPY>
</MAP>
</SEQUENCE>

<SEQUENCE EXIT-ON="FAILURE" FORM="FINALLY">

  <!-- nodes -->

<INVOKE SERVICE="com.example.cleanup:releaseResources">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/orderId;1;0" TO="/orderRef;1;0">
</MAPCOPY>

<MAPCOPY FROM="/processedItems;2;1" TO="/items;2;1">
</MAPCOPY>
</MAP>

<MAP MODE="OUTPUT">

  <!-- nodes -->

<MAPCOPY FROM="/cleanupStatus;1;0" TO="/cleanupResult;1;0">
</MAPCOPY>
</MAP>
</INVOKE>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/cleanupFailed;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">cleanupResult!="SUCCESS"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">cleanupFailed</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>

<INVOKE SERVICE="com.example.audit:logTransaction">

  <!-- nodes -->

<MAP MODE="INPUT">

  <!-- nodes -->

<MAPCOPY FROM="/orderId;1;0" TO="/orderRef;1;0">
</MAPCOPY>

<MAPCOPY FROM="/status;1;0" TO="/finalStatus;1;0">
</MAPCOPY>

<MAPCOPY FROM="/totalAmount;3;0" TO="/amount;1;0">
</MAPCOPY>

<MAPSET NAME="Setter" OVERWRITE="true" VARIABLES="false" GLOBALVARIABLES="false" FIELD="/timestamp;1;0">
  <DATA ENCODING="XMLValues" I18N="true">

<Values version="2.0">
  <value name="xml">"2024-01-01T00:00:00Z"</value>
  <record name="type" javaclass="com.wm.util.Values">
    <value name="node_type">record</value>
    <value name="node_subtype">unknown</value>
    <value name="is_public">false</value>
    <value name="field_name">timestamp</value>
    <value name="field_type">string</value>
    <value name="field_dim">0</value>
    <value name="nillable">true</value>
    <value name="form_qualified">false</value>
    <value name="is_global">false</value>
  </record>
</Values>
</DATA>
</MAPSET>
</MAP>
</INVOKE>
</SEQUENCE>

<MAP MODE="STANDALONE">

  <!-- nodes -->

<MAPDELETE FIELD="/validationFailed;1;0">
</MAPDELETE>

<MAPDELETE FIELD="/retryCount;1;0">
</MAPDELETE>

<MAPDELETE FIELD="/paymentStatus;1;0">
</MAPDELETE>

<MAPDELETE FIELD="/cleanupResult;1;0">
</MAPDELETE>
</MAP>
</FLOW>
